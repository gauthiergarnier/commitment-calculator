# Upsun configuration, generated using AI at: 2025-11-27T03:25:06.852Z
# AI can make mistakes. Please modify this file to suit your needs.
applications:
  app:
    type: nodejs:24

    build:
      flavor: none

    hooks:
      build: |
        set -ex
        npm install --omit=dev
        npm run build
        mv .next .next-built

      deploy: |
        set -ex
        touch .next/build-tree-id
        if [ "$(< .next/build-tree-id)" != "$PLATFORM_TREE_ID" ]; then
          cp -Rs $PWD/.next-built/* .next
          echo -n "$PLATFORM_TREE_ID" > .next/build-tree-id
        fi

    web:
      commands:
        pre_start: |
          touch .next/build-tree-id
          if [ "$(< .next/build-tree-id)" != "$PLATFORM_TREE_ID" ]; then
            echo >&2 "Waiting for deployment to complete"
            while [ "$(< .next/build-tree-id)" != "$PLATFORM_TREE_ID" ]; do sleep 1; done
          fi
        start: npm run start -p "$PORT"

      locations:
        /:
          root: .next
          passthru: true
          expires: 1h
          scripts: false

    variables:
      env:
        NEXT_TELEMETRY_DISABLED: '1'

    mounts:
      .next:
        source: storage

routes:
  https://{default}/:
    type: upstream
    upstream: app:http